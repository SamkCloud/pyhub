#!/usr/bin/python
# -*- coding: utf-8 -*-
# gd 20130804
"""
correct some part of latex file generated by pandoc to clean up the latex file

"""


import argparse
import re
import subprocess
import shutil
import os

def print_r(v):
    return '%s = %r %s' % (v, v, type(v))

	
def includegraphics2figure(args=None):
	"""
		Subsitute all includegraphics with the \bgefin{figure} part
	"""
	
	shutil.move(args.input,args.input+'.tmp')
	out = open(args.input,'w',encoding='utf8')
	
	indici_inseriti = []
	
	with open(args.input+'.tmp','r',encoding='utf8') as f:
		for line in f:
			espressione = '\includegraphics\{index'
			if not re.search(espressione, line,re.I):
				out.write(line)
			else: 
				(sl,sr) = line.split('-')
				(img_number_0,srr) = sr.split('.')
				(img_extension,othe) = srr.split('}')
				(img_number,minor_number) = img_number_0.split('_')
				new_string = """
\\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\\textwidth]{Images/index-###NUM###.png}
	\caption{}
	\label{fig_x###NUM###}
\end{figure}

"""
				final_0 = new_string.replace("###NUM###",img_number)
				final_1 = final_0.replace("###EXT###",img_extension)
				
				# non iserisce immagini gia' inserite (le immagini dei pdf possono essere divise verticaleente e per questo bisogna riunirle )
				if img_number not in indici_inseriti:
					out.write(final_1)
					indici_inseriti.append(img_number)
				
	os.remove(args.input+'.tmp')
			

def run(args=None):

	shutil.copy(args.input,args.input+'.bak')
	includegraphics2figure(args)
			
def main():
	
	parser = argparse.ArgumentParser(description='Demo of argparse')
	parser.add_argument("input", help='input file')
#	parser.add_argument('-o','--output',help='Output file name', default='output.tex')
	args = parser.parse_args()

	run(args)

if __name__ == '__main__':
    main()
    


